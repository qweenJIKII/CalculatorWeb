<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#171a2b" />
  <link rel="manifest" href="./manifest.webmanifest" />
  <title>簡易電卓 | ExternalIntegrationSamples</title>
  <style>
    :root {
      --bg: #0f1222;
      --panel: #171a2b;
      --panel-2: #1f2340;
      --text: #e9ecf1;
      --muted: #a8b0c2;
      --accent: #6ea8ff;
      --accent-2: #4ade80;
      --danger: #ff6b6b;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: radial-gradient(1200px 600px at 10% 0%, #13173a 0%, var(--bg) 50%, #0b0e1a 100%);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans JP", sans-serif;
      display: flex;
      align-items: flex-start;
      justify-content: center;
      min-height: 100dvh;
      padding: 16px env(safe-area-inset-right) calc(16px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
      overflow: auto;
    }
    .app {
      width: min(420px, 92vw);
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid rgba(255,255,255,0.06);
      border-radius: 16px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.35), inset 0 1px 0 rgba(255,255,255,0.04);
      overflow: auto;
    }
    .header {
      display: flex; align-items: center; justify-content: space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .title { font-weight: 600; letter-spacing: .2px; }
    .hint { color: var(--muted); font-size: 12px; }

    .display {
      padding: 18px 16px 8px 16px;
      display: grid;
      gap: 8px;
      background: rgba(255,255,255,0.02);
      border-bottom: 1px solid rgba(255,255,255,0.06);
    }
    .expr, .result {
      width: 100%;
      text-align: right;
      overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
    }
    .expr { min-height: 28px; color: var(--muted); font-size: clamp(16px, 2.2vh, 18px); }
    .result { min-height: 40px; font-size: 28px; font-variant-numeric: tabular-nums; }

    .keys {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      padding: 14px;
      background: rgba(255,255,255,0.01);
      grid-auto-rows: minmax(44px, auto);
      padding-bottom: calc(env(safe-area-inset-bottom) + 12px);
    }
    button.key {
      appearance: none; border: 0; cursor: pointer;
      padding: 14px 0; border-radius: 12px;
      color: var(--text);
      font-size: 18px; font-weight: 600;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 4px 10px rgba(0,0,0,0.18), inset 0 1px 0 rgba(255,255,255,0.04);
      transition: transform .03s ease-in-out, filter .15s ease, background .2s ease;
      user-select: none;
    }
    button.key:active { transform: translateY(1px); }
    .op { color: var(--accent); }
    .util { color: var(--muted); font-weight: 700; }
    .danger { color: var(--danger); }
    .equals { background: linear-gradient(180deg, rgba(110,168,255,0.25), rgba(110,168,255,0.08)); border-color: rgba(110,168,255,0.45); }
    .ok { background: linear-gradient(180deg, rgba(74,222,128,0.25), rgba(74,222,128,0.08)); border-color: rgba(74,222,128,0.45); }

    .toolbar { display: grid; grid-template-columns: repeat(5, 1fr); gap: 10px; padding: 12px 14px; background: rgba(255,255,255,0.02); border-bottom: 1px solid rgba(255,255,255,0.06); }
    .footer { padding: 10px 14px 16px; text-align: center; color: var(--muted); font-size: 12px; }
    .footer kbd { padding: 2px 6px; border-radius: 6px; border: 1px solid rgba(255,255,255,.1); background: rgba(255,255,255,.03); }

    /* Utility spans for larger keys */
    .keys .wide-2 { grid-column: span 2; }
    .keys .wide-3 { grid-column: span 3; }

    /* Tabs (ヘッダー下の簡易ナビ) */
    .tabs { display:flex; gap:10px; padding: 8px 14px; border-bottom:1px solid rgba(255,255,255,0.06); background: rgba(255,255,255,0.02); overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch; }
    .tabs .tab { color: var(--muted); text-decoration: none; padding:6px 10px; border:1px solid rgba(255,255,255,.08); border-radius: 8px; background: rgba(255,255,255,.02); font-size: 13px; flex:0 0 auto; white-space:nowrap; }
    .tabs .tab.active { color: var(--text); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.05); }

    /* 科学関数の折りたたみ: app[data-sci="off"] の間は非表示 */
    .app[data-sci="off"] .key[data-group="sci"] { display: none; }

    /* 関数OFF時: 括弧2つで1行(4列)を埋めて次の行頭を揃える */
    .app[data-sci="off"] .keys .key[data-val="("] { grid-column: span 2; }
    .app[data-sci="off"] .keys .key[data-val=")"] { grid-column: span 2; }

    /* ボタンの動的サイズ（小画面で自動縮小） */
    button.key { padding: clamp(10px, 2vh, 14px) 0; font-size: clamp(16px, 2.4vh, 18px); }

    /* Mobile full-screen adjustments */
    @media (max-width: 720px) {
      body { padding: env(safe-area-inset-top) env(safe-area-inset-right) env(safe-area-inset-bottom) env(safe-area-inset-left); }
      .app { width: 100vw; min-height: 100svh; border-radius: 0; overflow-y: auto; }
      .header { padding: 12px 14px; }
      .display { padding: 16px 14px 8px 14px; }
      .result { font-size: clamp(24px, 6.0vh, 54px); }
      .keys { gap: 8px; padding: 12px; padding-bottom: calc(env(safe-area-inset-bottom) + 96px); overflow-y: auto; scroll-padding-bottom: 96px; }
      .toolbar { padding: 8px 12px; gap: 6px; }
      button.key { padding: clamp(6px, 1.9vh, 10px) 0; font-size: clamp(14px, 2.1vh, 17px); }
    }

    /* Very short viewport height adjustments */
    @media (max-height: 720px) {
      .result { font-size: clamp(22px, 5.5vh, 48px); }
      .keys { gap: 6px; }
      .toolbar { gap: 8px; }
      button.key { padding: clamp(6px, 1.8vh, 10px) 0; font-size: clamp(14px, 2vh, 17px); }
    }

    /* History modal */
    .modal { position: fixed; inset: 0; display: none; z-index: 1000; }
    .modal[aria-hidden="false"] { display: block; }
    .modal-backdrop { position: absolute; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(2px); }
    .modal-panel {
      position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: min(480px, 92vw); max-height: 80vh;
      background: linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%);
      border: 1px solid rgba(255,255,255,0.1); border-radius: 14px; box-shadow: 0 20px 50px rgba(0,0,0,0.45);
      display: grid; grid-template-rows: auto 1fr; overflow: hidden;
    }
    .modal-header { display: flex; align-items: center; justify-content: space-between; gap: 8px; padding: 10px 12px; border-bottom: 1px solid rgba(255,255,255,0.08); }
    .modal-title { font-weight: 600; }
    .modal-body { padding: 12px; overflow: auto; }
  </style>
</head>
<body>
  <main class="app" role="application" aria-label="電卓" data-sci="off">
    <div class="header">
      <div class="title">簡易電卓</div>
      <div class="hint">クリック / キーボード対応</div>
    </div>
    <nav class="tabs" aria-label="ナビゲーション">
      <a class="tab active" href="./">電卓</a>
      <a class="tab" href="./help.html">説明</a>
      <a class="tab" href="./memo.html">メモ</a>
      <a class="tab" href="./qr.html">QR</a>
      <a class="tab" href="./timer.html">タイマー</a>
      <a class="tab" href="./convert.html">換算</a>
      <a class="tab" href="./password.html">PW</a>
      <a class="tab" href="./voice.html">音声</a>
      <a class="tab" href="./ocr.html">OCR</a>
    </nav>

    <section class="display" aria-live="polite">
      <div id="expr" class="expr" title="式"></div>
      <div id="result" class="result" title="結果">0</div>
    </section>

    <section class="toolbar">
      <button class="key util" data-act="toggle-deg" aria-label="角度単位切替">度</button>
      <button class="key util" data-act="copy-res" aria-label="結果をコピー">コピー</button>
      <button class="key util" data-act="paste" aria-label="貼り付け">貼り付け</button>
      <button class="key util" data-act="share" aria-label="共有">共有</button>
      <button class="key util" data-act="toggle-sci" aria-label="関数の表示切替">関数</button>
    </section>

    <section class="keys">
      <!-- Memory row -->
      <button class="key util" data-act="mc" aria-label="メモリクリア">MC</button>
      <button class="key util" data-act="mr" aria-label="メモリリコール">MR</button>
      <button class="key util" data-act="mplus" aria-label="メモリ加算">M+</button>
      <button class="key util" data-act="mminus" aria-label="メモリ減算">M-</button>

      <!-- Clear / edit row -->
      <button class="key util danger" data-act="clear" aria-label="すべてクリア">AC</button>
      <button class="key util" data-act="ce" aria-label="エントリクリア">CE</button>
      <button class="key util" data-act="back" aria-label="削除">⌫</button>
      <button class="key util" data-act="percent" aria-label="パーセント">%</button>

      <!-- scientific / parens -->
      <button class="key op" data-val="(" aria-label="左括弧">(</button>
      <button class="key op" data-val=")" aria-label="右括弧">)</button>
      <button class="key util" data-act="sqrt" data-group="sci" aria-label="平方根">√</button>
      <button class="key util" data-act="square" data-group="sci" aria-label="2乗">x²</button>

      <!-- scientific row 2 -->
      <button class="key" data-val="sin(" data-group="sci">sin</button>
      <button class="key" data-val="cos(" data-group="sci">cos</button>
      <button class="key" data-val="tan(" data-group="sci">tan</button>
      <button class="key" data-val="^" data-group="sci">^</button>

      <!-- scientific row 3 -->
      <button class="key" data-val="log(" data-group="sci">log</button>
      <button class="key" data-val="ln(" data-group="sci">ln</button>
      <button class="key" data-act="const-pi" data-group="sci">π</button>
      <button class="key" data-act="const-e" data-group="sci">e</button>

      <!-- numbers -->
      <button class="key" data-val="7">7</button>
      <button class="key" data-val="8">8</button>
      <button class="key" data-val="9">9</button>
      <button class="key op" data-val="/">÷</button>

      <button class="key" data-val="4">4</button>
      <button class="key" data-val="5">5</button>
      <button class="key" data-val="6">6</button>
      <button class="key op" data-val="*">×</button>

      <button class="key" data-val="1">1</button>
      <button class="key" data-val="2">2</button>
      <button class="key" data-val="3">3</button>
      <button class="key op" data-val="-">−</button>

      <button class="key util" data-act="neg" aria-label="符号反転">±</button>
      <button class="key" data-val="0">0</button>
      <button class="key" data-val=".">.</button>
      <button class="key op" data-val="+">＋</button>

      <!-- bottom row -->
      <button class="key util" data-act="recip" data-group="sci" aria-label="逆数">1/x</button>
      <button class="key util" data-act="show-history" aria-label="履歴を開く">履歴</button>
      <button class="key key-enter equals wide-2" data-act="equals" aria-label="計算">＝</button>
    </section>

    <!-- History Modal -->
    <div id="historyModal" class="modal" aria-hidden="true" role="dialog" aria-modal="true" aria-labelledby="historyTitle">
      <div class="modal-backdrop" data-act="close-history"></div>
      <div class="modal-panel">
        <div class="modal-header">
          <div id="historyTitle" class="modal-title">履歴（最新10件）</div>
          <button id="historyClose" class="key util" data-act="close-history" aria-label="閉じる">×</button>
        </div>
        <div class="modal-body">
          <ul id="history" style="list-style:none; padding-left:0; margin:0; display:grid; gap:6px;"></ul>
        </div>
      </div>
    </div>

    <div class="footer">
      <span><kbd>0-9</kbd> <kbd>+ − × ÷</kbd> <kbd>.</kbd> <kbd>Enter</kbd> <kbd>Backspace</kbd> <kbd>Esc</kbd> / メモリ: MC MR M+ M-</span>
      <div style="margin-top:8px; opacity:.8">履歴は下部の「履歴」ボタンから開けます。</div>
    </div>
  </main>

  <script>
    (function() {
      const exprEl = document.getElementById('expr');
      const resultEl = document.getElementById('result');
      const historyEl = document.getElementById('history');
      const historyModal = document.getElementById('historyModal');
      let expr = '';
      let memory = 0;
      const history = [];
      let degMode = true; // true: DEG, false: RAD
      let sciExpanded = false;
      let lastWasEquals = false; // 次入力の扱いを制御

      function update() {
        exprEl.textContent = expr || '';
      }

      function sanitize(input) {
        // 許可文字のみ（数字, 演算子, 小数点, 括弧, 空白, カンマ, 英字, ^）
        const ok = /^[0-9+\-*/().,^\sA-Za-z]+$/;
        return ok.test(input);
      }

      function compute(expression) {
        if (!expression) return '0';
        if (!sanitize(expression)) return 'Error';
        const cleaned = expression.replace(/\s+/g, '');
        // ^ を ** に変換
        const exprJS = expression.replace(/\^/g, '**');
        // 識別子のホワイトリスト検証
        const ids = (exprJS.match(/[A-Za-z_][A-Za-z0-9_]*/g) || []);
        const allow = new Set(['sin','cos','tan','log','ln','exp','pow','PI','E']);
        for (const id of ids) { if (!allow.has(id)) return 'Error'; }
        // 安全なスコープ提供
        const toRad = (x) => x * Math.PI / 180;
        const sin = (x) => Math.sin(degMode ? toRad(x) : x);
        const cos = (x) => Math.cos(degMode ? toRad(x) : x);
        const tan = (x) => Math.tan(degMode ? toRad(x) : x);
        const log = (x) => Math.log10(x);
        const ln  = (x) => Math.log(x);
        const exp = (x) => Math.exp(x);
        const pow = (a,b) => Math.pow(a,b);
        const PI = Math.PI; const E = Math.E;
        try {
          // eslint-disable-next-line no-new-func
          const fn = Function('sin','cos','tan','log','ln','exp','pow','PI','E','"use strict"; return (' + exprJS + ')');
          const val = fn(sin,cos,tan,log,ln,exp,pow,PI,E);
          if (typeof val === 'number' && Number.isFinite(val)) {
            return String(+parseFloat(val.toFixed(12)));
          }
          return 'Error';
        } catch (e) { return 'Error'; }
      }

      function setResultText(text){ resultEl.textContent = text; }

      function insert(val) {
        if (lastWasEquals) { // 数字/記号系は新規入力として開始
          expr = '';
          lastWasEquals = false;
        }
        expr += val; update();
      }
      const OPS = new Set(['+','-','*','/','^']);
      function isOp(c){ return OPS.has(c); }
      function addOperator(op){
        if (!isOp(op)) { insert(op); return; }
        if (expr.length === 0) {
          // 先頭のマイナスは許容（負数）
          if (op === '-') { insert('-'); }
          return;
        }
        if (lastWasEquals) {
          // 直前結果を左オペランドとして継続計算
          const resText = resultEl.textContent;
          const num = Number(resText);
          if (Number.isFinite(num)) { expr = String(num); }
          lastWasEquals = false;
        }
        // 末尾の演算子の連続を1つに畳み込む
        // ただし、"(" の直後のマイナスは負符号として許可
        const last = expr.slice(-1);
        if (last === '(' && op === '-') { insert('-'); return; }
        // 末尾の連続演算子を除去
        expr = expr.replace(/[+\-*/^]+$/, '');
        // 置換として現在の演算子を付与
        insert(op);
      }
      function back() { expr = expr.slice(0, -1); update(); }
      function clearAll() { expr = ''; update(); setResultText('0'); }
      function clearEntry() {
        // 末尾の数値のみクリア
        const m = expr.match(/(-?\d*\.?\d+)\s*$/);
        if (m) { expr = expr.slice(0, m.index); update(); }
      }
      function toggleSign() {
        const m = expr.match(/(-?\d*\.?\d+)\s*$/);
        if (!m) return; const num = m[1];
        const toggled = (num.startsWith('-') ? num.slice(1) : '-' + num);
        expr = expr.slice(0, m.index) + toggled; update();
      }
      function percent() {
        const m = expr.match(/(\d*\.?\d+)\s*$/);
        if (!m) return; const num = m[1];
        expr = expr.slice(0, m.index) + '(' + num + '/100)'; update();
      }
      function sqrtLast() {
        const m = expr.match(/(\d*\.?\d+)\s*$/);
        if (!m) return; const num = m[1];
        expr = expr.slice(0, m.index) + '(' + num + ')**0.5'; update();
      }
      function squareLast() {
        const m = expr.match(/(\d*\.?\d+)\s*$/);
        if (!m) return; const num = m[1];
        expr = expr.slice(0, m.index) + '(' + num + ')**2'; update();
      }
      function recipLast() {
        const m = expr.match(/(\d*\.?\d+)\s*$/);
        if (!m) return; const num = m[1];
        expr = expr.slice(0, m.index) + '(1/(' + num + '))'; update();
      }

      function equals() {
        const r = compute(expr);
        setResultText(r);
        if (r !== 'Error') {
          history.unshift({ ex: expr, res: r });
          if (history.length > 10) history.pop();
          renderHistory();
          saveState();
          lastWasEquals = true;
        }
      }

      function renderHistory() {
        if (!historyEl) return;
        historyEl.innerHTML = history.map((h, i) => {
          return `<li style="display:flex; gap:8px; align-items:center; justify-content:space-between; background:rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.08); padding:6px 8px; border-radius:8px;">
            <span style="opacity:.8">${h.ex} = <strong>${h.res}</strong></span>
            <button class="key" style="padding:6px 10px; font-size:12px;" data-act="use-history" data-idx="${i}">使用</button>
          </li>`;
        }).join('');
      }

      function openHistory(){ historyModal?.setAttribute('aria-hidden','false'); }
      function closeHistory(){ historyModal?.setAttribute('aria-hidden','true'); }

      function memoryClear(){ memory = 0; }
      function memoryRecall(){ insert(String(memory)); }
      function memoryPlus(){ const v = Number(resultEl.textContent) || 0; memory += v; saveState(); }
      function memoryMinus(){ const v = Number(resultEl.textContent) || 0; memory -= v; saveState(); }

      // Clipboard / Share
      async function copyResult(){ try { await navigator.clipboard?.writeText(resultEl.textContent); } catch(_){} }
      async function pasteExpr(){
        try {
          const read = await navigator.clipboard?.readText?.();
          if (!read) return;
          // 許可された文字のみ（数字/演算子/小数点/括弧/^/英字）
          const cleaned = (read.match(/[0-9+\-*/().,^A-Za-z]+/g) || []).join("");
          if (!cleaned) return;
          insert(cleaned);
        } catch(_){}
      }
      async function share(){
        const data = { title: '簡易電卓', text: `${expr || ''} = ${resultEl.textContent}`, url: location.href };
        if (navigator.share) { try { await navigator.share(data); return; } catch(_){} }
        await copyResult();
      }

      // DEG/RAD toggle
      function toggleDeg(){
        degMode = !degMode;
        document.querySelector('[data-act="toggle-deg"]').textContent = degMode ? '度' : 'ラジアン';
        saveState();
      }

      // Sci toggle
      function applySciState(){
        const app = document.querySelector('.app');
        app?.setAttribute('data-sci', sciExpanded ? 'on' : 'off');
      }
      function toggleSci(){
        sciExpanded = !sciExpanded;
        applySciState();
        saveState();
      }

      // Constants
      function insertPI(){ insert('PI'); }
      function insertE(){ insert('E'); }

      // Haptics
      function haptic(){ try { navigator.vibrate && navigator.vibrate(10); } catch(_){} }

      // Persistence
      function saveState(){
        try {
          localStorage.setItem('calc_history', JSON.stringify(history));
          localStorage.setItem('calc_memory', JSON.stringify(memory));
          localStorage.setItem('calc_deg', JSON.stringify(degMode));
          localStorage.setItem('calc_sci', JSON.stringify(sciExpanded));
        } catch(_){}}
      function loadState(){
        try {
          const h = JSON.parse(localStorage.getItem('calc_history')||'[]');
          const m = JSON.parse(localStorage.getItem('calc_memory')||'0');
          const d = JSON.parse(localStorage.getItem('calc_deg')||'true');
          const s = JSON.parse(localStorage.getItem('calc_sci')||'false');
          if (Array.isArray(h)) { history.splice(0, history.length, ...h.slice(0,10)); renderHistory(); }
          if (typeof m === 'number') memory = m;
          degMode = !!d; document.querySelector('[data-act="toggle-deg"]').textContent = degMode ? '度' : 'ラジアン';
          sciExpanded = !!s; applySciState();
        } catch(_){}
      }

      // Click handlers
      document.addEventListener('click', (ev) => {
        const btn = ev.target.closest('button.key');
        if (!btn) {
          // backdrop click support
          const closeOnBackdrop = ev.target?.getAttribute && ev.target.getAttribute('data-act') === 'close-history';
          if (closeOnBackdrop) { closeHistory(); }
          return;
        }
        const act = btn.getAttribute('data-act');
        const val = btn.getAttribute('data-val');
        if (act) {
          if (act === 'clear') return clearAll();
          if (act === 'ce') return clearEntry();
          if (act === 'back') return back();
          if (act === 'equals') return equals();
          if (act === 'percent') return percent();
          if (act === 'sqrt') return sqrtLast();
          if (act === 'square') return squareLast();
          if (act === 'recip') return recipLast();
          if (act === 'neg') return toggleSign();
          if (act === 'mc') return memoryClear();
          if (act === 'mr') return memoryRecall();
          if (act === 'mplus') return memoryPlus();
          if (act === 'mminus') return memoryMinus();
          if (act === 'copy-res') return copyResult();
          if (act === 'paste') return pasteExpr();
          if (act === 'share') return share();
          if (act === 'toggle-deg') return toggleDeg();
          if (act === 'toggle-sci') return toggleSci();
          if (act === 'const-pi') return insertPI();
          if (act === 'const-e') return insertE();
          if (act === 'show-history') return openHistory();
          if (act === 'close-history') return closeHistory();
          if (act === 'use-history') {
            const idx = Number(btn.getAttribute('data-idx'));
            const item = history[idx];
            if (item) { expr = item.res; update(); setResultText(item.res); closeHistory(); }
            return;
          }
        }
        if (val) {
          if (isOp(val)) { addOperator(val); }
          else { insert(val); }
        }
        haptic();
      });

      // Keyboard support
      window.addEventListener('keydown', (e) => {
        if (historyModal && historyModal.getAttribute('aria-hidden') === 'false') {
          if (e.key === 'Escape') { e.preventDefault(); closeHistory(); return; }
        }
        if (e.key === 'Enter') { e.preventDefault(); equals(); return; }
        if (e.key === 'Backspace') { back(); return; }
        if (e.key === 'Escape') { clearAll(); return; }
        const map = { '%': percent };
        if (map[e.key]) { map[e.key](); return; }
        const k = e.key;
        const allowed = '0123456789+-*/().,^';
        if (allowed.includes(k)) {
          if (isOp(k)) { addOperator(k); return; }
          insert(k); return;
        }
        // quick functions typing
        if (/^[a-z]$/i.test(k)) { insert(k); }
      });

      // SW registration (best-effort)
      if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
          navigator.serviceWorker.register('./sw.js').catch(() => {});
        });
      }

      loadState();
      update();
    })();
  </script>
</body>
</html>
