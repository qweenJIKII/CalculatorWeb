<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="theme-color" content="#171a2b"/>
  <title>製品詳細 | 簡易電卓</title>
  <link rel="manifest" href="./manifest.webmanifest"/>
  <style>
    :root { --bg:#0f1222; --panel:#171a2b; --panel-2:#1f2340; --text:#e9ecf1; --muted:#a8b0c2; --accent:#6ea8ff; }
    html,body{height:100%}
    body{ margin:0; background: radial-gradient(1200px 600px at 10% 0%, #13173a 0%, var(--bg) 50%, #0b0e1a 100%); color:var(--text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif; display:flex; align-items:flex-start; justify-content:center; min-height:100dvh; padding:16px env(safe-area-inset-right) calc(16px + env(safe-area-inset-bottom)) env(safe-area-inset-left); overflow:auto; }
    .app{ width:min(820px,96vw); background:linear-gradient(180deg,var(--panel) 0%, var(--panel-2) 100%); border:1px solid rgba(255,255,255,.06); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
    .header{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); }
    .tabs{ display:flex; gap:10px; padding: 8px 14px; border-bottom:1px solid rgba(255,255,255,.06); background: rgba(255,255,255,0.02); overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch; }
    .tab{ color: var(--muted); text-decoration: none; padding:6px 10px; border:1px solid rgba(255,255,255,.08); border-radius:8px; background: rgba(255,255,255,.02); font-size:13px; flex:0 0 auto; white-space:nowrap; }
    .tab.active{ color:var(--text); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.05); }
    .content{ padding:16px 14px 22px; display:grid; gap:14px; }
    .card{ border:1px solid rgba(255,255,255,.08); border-radius:12px; background: rgba(255,255,255,.03); padding:14px; }
    .title2{ font-weight:700; margin-bottom:8px; }
    .row{ display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
    .btn{ padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); color:var(--text); font-weight:700; cursor:pointer; }
    .muted{ color:var(--muted); font-size:12px; }
    table{ width:100%; border-collapse:collapse; }
    th, td{ text-align:left; padding:8px 10px; border-bottom:1px solid rgba(255,255,255,.08); }
  </style>
</head>
<body>
  <main class="app" aria-label="製品詳細">
    <div class="header">
      <div class="title">簡易電卓 - 製品詳細</div>
      <div class="muted">コードで検索</div>
    </div>
    <nav class="tabs" aria-label="ナビゲーション">
      <a class="tab" href="./">電卓</a>
      <a class="tab" href="./help.html">説明</a>
      <a class="tab" href="./memo.html">メモ</a>
      <a class="tab" href="./camera.html">カメラ</a>
      <a class="tab" href="./qr.html">QR</a>
      <a class="tab" href="./timer.html">タイマー</a>
      <a class="tab" href="./convert.html">換算</a>
      <a class="tab" href="./password.html">PW</a>
      <a class="tab" href="./voice.html">音声</a>
      <a class="tab" href="./music.html">音楽</a>
      <a class="tab active" href="./product.html">製品</a>
      <a class="tab" href="./calendar.html">カレンダー</a>
    </nav>

    <section class="content">
      <div class="card">
        <div class="row" style="justify-content:space-between; align-items:flex-end;">
          <div>
            <div id="name" class="title2">製品名</div>
            <div class="muted">コード: <span id="code">-</span> / ブランド: <span id="brand">-</span> / カテゴリ: <span id="category">-</span></div>
          </div>
          <div class="row">
            <button id="shareBtn" class="btn">共有</button>
          </div>
        </div>
        <p id="desc" style="margin:10px 0 0;">説明</p>
      </div>
      <div id="settingsCard" class="card">
        <div class="title2">設定</div>
        <label class="row" style="gap:8px;">
          <input id="useOnlineToggle" type="checkbox" />
          <span class="muted">オンライン補完を使用（Open * Facts）</span>
        </label>
        <label class="row" style="gap:8px;">
          <input id="saveHistoryToggle" type="checkbox" />
          <span class="muted">読み込み結果を履歴に保存</span>
        </label>
      </div>
      <div id="historyCard" class="card" style="display:none;">
        <div class="title2">履歴</div>
        <div id="historyList" class="muted"></div>
      </div>
      <div id="specCard" class="card" style="display:none;">
        <div class="title2">仕様</div>
        <table id="specs"></table>
      </div>
      <div class="muted">製品データは `data/products.json` に格納されています。コードが一致する製品が見つからない場合は基本情報のみ表示します。</div>
    </section>
  </main>

  <script>
    (function(){
      const $ = (s)=> document.querySelector(s);
      const params = new URLSearchParams(location.search);
      const codeParam = (params.get('code')||'').trim();
      const code = codeParam.replace(/\s+/g,'');
      const isLikelyCode = /^\d{8}$|^\d{12}$|^\d{13}$/.test(code);
      const state = { product:null };
      const SETTINGS_KEY = 'cw_product_settings';
      const HISTORY_KEY = 'cw_product_history_v1';
      const CACHE_KEY = 'cw_product_cache_v1';

      function render(){
        const p = state.product || { code: code || '-', name:'不明な製品', brand:'-', category:'-', description:'一致する製品が見つかりませんでした。', specs:{} };
        $('#name').textContent = p.name || '製品';
        $('#code').textContent = p.code || code || '-';
        $('#brand').textContent = p.brand || '-';
        $('#category').textContent = p.category || '-';
        $('#desc').textContent = p.description || '';
        const specs = p.specs || {};
        const specTable = $('#specs');
        specTable.innerHTML = '';
        const keys = Object.keys(specs);
        if (keys.length){
          $('#specCard').style.display = '';
          for (const k of keys){
            const v = Array.isArray(specs[k]) ? specs[k].join(', ') : (typeof specs[k]==='object' ? JSON.stringify(specs[k]) : String(specs[k]));
            const tr = document.createElement('tr');
            tr.innerHTML = `<th style="width:30%">${k}</th><td>${v}</td>`;
            specTable.appendChild(tr);
          }
        } else { $('#specCard').style.display = 'none'; }
      }

      // --- Online fetchers (fallback) ---
      function normalizeFromOFF(prod, barcode){
        if (!prod) return null;
        const name = prod.product_name || prod.generic_name || prod.product_name_en || '';
        const brand = (prod.brands || '').split(',')[0]?.trim() || '';
        const category = (prod.categories || '').split(',')[0]?.trim() || '';
        const description = prod.generic_name || prod.ingredients_text || prod.labels || '';
        const nutr = prod.nutriments || {};
        const specs = {};
        if (prod.quantity) specs.quantity = prod.quantity;
        if (prod.ingredients_text) specs.ingredients = prod.ingredients_text.split(/,\s*/).filter(Boolean);
        const take = (k)=> (k in nutr) ? nutr[k] : undefined;
        const nutro = {
          energy_kcal_100g: take('energy-kcal_100g'),
          proteins_100g: take('proteins_100g'),
          fat_100g: take('fat_100g'),
          carbohydrates_100g: take('carbohydrates_100g'),
          sugars_100g: take('sugars_100g'),
          salt_100g: take('salt_100g')
        };
        const nutroKeys = Object.keys(nutro).filter(k=> nutro[k] !== undefined);
        if (nutroKeys.length) specs.nutriments = nutro;
        if (Array.isArray(prod.brands_tags) && prod.brands_tags.length) specs.brands_tags = prod.brands_tags;
        if (Array.isArray(prod.categories_tags) && prod.categories_tags.length) specs.categories_tags = prod.categories_tags;
        return {
          code: barcode,
          name: name || '(名称不明)',
          brand: brand || '-',
          category: category || '-',
          description: description,
          specs
        };
      }

      async function fetchFromOFFHost(host, barcode){
        try{
          const url = `https://${host}/api/v2/product/${encodeURIComponent(barcode)}.json`;
          const res = await fetch(url, { cache: 'no-store' });
          if (!res.ok) return null;
          const json = await res.json();
          const prod = json?.product;
          if (!prod) return null;
          return normalizeFromOFF(prod, barcode);
        }catch(_){ return null; }
      }

      async function fetchOnlineProduct(barcode){
        // Try multiple Open * Facts families to cover more product types
        const hosts = [
          'world.openfoodfacts.org',
          'world.openproductsfacts.org',
          'world.openbeautyfacts.org',
          'world.openpetfoodfacts.org'
        ];
        for (const h of hosts){
          const r = await fetchFromOFFHost(h, barcode);
          if (r) return r;
        }
        return null;
      }

      // --- Settings & History ---
      // Cache (full product objects)
      function loadCache(){ try{ return JSON.parse(localStorage.getItem(CACHE_KEY)||'{}')||{}; }catch(_){ return {}; } }
      function saveCache(obj){ localStorage.setItem(CACHE_KEY, JSON.stringify(obj)); }
      function getCachedProduct(code){ if (!code) return null; const c = loadCache(); return c[code] || null; }
      function cacheProduct(p){ if (!p || !p.code) return; const c = loadCache(); c[p.code] = p; saveCache(c); }

      function loadSettings(){
        try{ return JSON.parse(localStorage.getItem(SETTINGS_KEY)||'{}')||{}; }catch(_){ return {}; }
      }
      function saveSettings(s){ localStorage.setItem(SETTINGS_KEY, JSON.stringify(s)); }
      function getSettings(){
        const s = loadSettings();
        return { useOnline: s.useOnline!==false, saveHistory: s.saveHistory!==false };
      }
      function renderSettings(){
        const s = getSettings();
        const useEl = document.getElementById('useOnlineToggle');
        const saveEl = document.getElementById('saveHistoryToggle');
        if (useEl){ useEl.checked = !!s.useOnline; useEl.addEventListener('change', ()=>{ const cur=getSettings(); cur.useOnline = useEl.checked; saveSettings(cur); }); }
        if (saveEl){ saveEl.checked = !!s.saveHistory; saveEl.addEventListener('change', ()=>{ const cur=getSettings(); cur.saveHistory = saveEl.checked; saveSettings(cur); renderHistory(); }); }
      }

      function loadHistory(){ try{ return JSON.parse(localStorage.getItem(HISTORY_KEY)||'[]')||[]; }catch(_){ return []; } }
      function saveHistory(list){ localStorage.setItem(HISTORY_KEY, JSON.stringify(list)); }
      function addToHistory(p){
        if (!p || !p.code) return;
        const s = getSettings(); if (!s.saveHistory) return;
        let list = loadHistory();
        list = list.filter(x=> x.code !== p.code);
        list.unshift({ code: p.code, name: p.name||'', brand: p.brand||'', at: Date.now() });
        if (list.length>50) list = list.slice(0,50);
        saveHistory(list);
      }
      function fmtDate(ts){ try{ return new Date(ts).toLocaleString(); }catch(_){ return ''; } }
      function renderHistory(){
        const list = loadHistory();
        const card = document.getElementById('historyCard');
        const wrap = document.getElementById('historyList');
        if (!wrap || !card) return;
        if (!list.length){ card.style.display='none'; wrap.innerHTML=''; return; }
        card.style.display='';
        wrap.innerHTML = '';
        for (const item of list){
          const a = document.createElement('a');
          a.href = `./product.html?code=${encodeURIComponent(item.code)}`;
          const cached = getCachedProduct(item.code) || {};
          const nm = cached.name || item.name || '(名称不明)';
          const br = cached.brand || item.brand || '';
          a.textContent = `${item.code} — ${nm} ${br?('('+br+')'):''} / ${fmtDate(item.at)}`;
          a.style.display='block'; a.style.color='var(--text)'; a.style.textDecoration='none'; a.style.margin='4px 0';
          wrap.appendChild(a);
        }
      }

      async function load(){
        try{
          if (!isLikelyCode && !code){ render(); return; }
          // 0) Cache quick hit
          state.product = getCachedProduct(code) || state.product || null;
          // 1) Local DB
          try{
            const res = await fetch('./data/products.json', { cache:'no-store' });
            if (res.ok){
              const json = await res.json();
              const list = json?.products || [];
              state.product = list.find(p=> (p.code||'') === code) || state.product || null;
            }
          }catch(_){ /* ignore */ }
          // 2) Online fallback if not found locally
          const s = getSettings();
          if (!state.product && s.useOnline){
            state.product = await fetchOnlineProduct(code);
          }
        }catch(_){ state.product = null; }
        render();
        if (state.product){ cacheProduct(state.product); addToHistory(state.product); renderHistory(); }
      }

      async function share(){
        const p = state.product || { name:'製品', code };
        const url = `${location.origin}${location.pathname}?code=${encodeURIComponent(p.code||code)}`;
        const text = `${p.name} (コード: ${p.code||code})\n${p.description||''}\n${url}`;
        if (navigator.share){ try{ await navigator.share({ title:p.name, text, url }); return; }catch(_){ } }
        try{ await navigator.clipboard?.writeText(text); alert('情報をコピーしました'); }catch(_){ }
      }

      $('#shareBtn').addEventListener('click', share);

      // SW best-effort
      if ('serviceWorker' in navigator){ window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }
      renderSettings();
      renderHistory();
      load();
    })();
  </script>
</body>
</html>
