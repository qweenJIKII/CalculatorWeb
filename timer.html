<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#171a2b" />
  <title>タイマー | 簡易電卓</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <style>
    :root { --bg:#0f1222; --panel:#171a2b; --panel-2:#1f2340; --text:#e9ecf1; --muted:#a8b0c2; --accent:#6ea8ff; --ok:#4ade80; --danger:#ff6b6b; }
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 600px at 10% 0%, #13173a 0%, var(--bg) 50%, #0b0e1a 100%);
      color:var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", sans-serif;
      display:flex; align-items:flex-start; justify-content:center;
      min-height:100dvh; padding: 16px env(safe-area-inset-right) calc(16px + env(safe-area-inset-bottom)) env(safe-area-inset-left);
    }
    .app{ width:min(820px, 96vw); background:linear-gradient(180deg, var(--panel) 0%, var(--panel-2) 100%); border:1px solid rgba(255,255,255,.06); border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.35); overflow:hidden; }
    .header{ display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid rgba(255,255,255,.06); }
    .tabs{ display:flex; gap:10px; padding: 8px 14px; border-bottom:1px solid rgba(255,255,255,.06); background: rgba(255,255,255,0.02); overflow-x:auto; overflow-y:hidden; -webkit-overflow-scrolling:touch; }
    .tab{ color: var(--muted); text-decoration: none; padding:6px 10px; border:1px solid rgba(255,255,255,.08); border-radius:8px; background: rgba(255,255,255,.02); font-size:13px; flex:0 0 auto; white-space:nowrap; }
    .tab.active{ color:var(--text); border-color: rgba(255,255,255,.18); background: rgba(255,255,255,.05); }
    .content{ padding:16px 14px 22px; display:grid; gap:14px; }

    .display{ font-size:64px; font-weight:800; text-align:center; letter-spacing:2px; }
    .controls{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .controls button{ padding:10px 16px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); color:var(--text); font-weight:700; cursor:pointer; }

    .progress{ height:8px; border-radius:999px; background: rgba(255,255,255,.08); overflow:hidden; }
    .progress .bar{ height:100%; width:0%; background: linear-gradient(90deg, #6ea8ff, #4ade80); transition: width .2s ease; }

    .presets{ display:flex; gap:8px; justify-content:center; flex-wrap:wrap; }
    .presets button{ padding:8px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.04); color:var(--text); cursor:pointer; font-size:12px; }

    .settings{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:center; }
    .settings input{ width:84px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background: rgba(0,0,0,.15); color:var(--text); }
    .cycle{ color:var(--muted); font-size:12px; text-align:center; }

    .sessions{ margin-top:8px; display:flex; gap:6px; flex-wrap:wrap; justify-content:center; }
    .pill{ font-size:12px; padding:4px 8px; border-radius:999px; background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:var(--muted); }

    /* mode tabs */
    .mode-tabs{ display:flex; gap:8px; justify-content:center; padding:4px 0 8px; }
    .mode-tab{ padding:6px 10px; border-radius:999px; border:1px solid rgba(255,255,255,.12); background:rgba(255,255,255,.04); color:var(--text); cursor:pointer; font-size:12px; }
    .mode-tab[aria-selected="true"]{ background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.2); color:#fff; }

    [data-mode="pomodoro"] #kitchenBox{ display:none; }
    [data-mode="kitchen"] #pomodoroBox, [data-mode="kitchen"] #pomodoroBox2, [data-mode="kitchen"] #cycle, [data-mode="kitchen"] #sessions{ display:none; }

    /* sound modal */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; }
    .modal{ position:fixed; inset:auto 0 0 0; margin:auto; top:10vh; width:min(560px, 92vw); background:var(--panel-2); border:1px solid rgba(255,255,255,.12); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.45); display:none; }
    .modal .hd{ padding:12px 14px; border-bottom:1px solid rgba(255,255,255,.08); font-weight:700; }
    .modal .bd{ padding:14px; display:grid; gap:12px; }
    .modal .ft{ padding:12px 14px; border-top:1px solid rgba(255,255,255,.08); display:flex; justify-content:flex-end; gap:8px; }
    .modal label{ display:flex; align-items:center; gap:8px; }
    .modal input[type="range"]{ width:180px; }
    .btn{ padding:8px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background: rgba(255,255,255,.05); color:var(--text); cursor:pointer; }
    .btn.primary{ background: linear-gradient(180deg, rgba(110,168,255,.5), rgba(110,168,255,.15)); border-color: rgba(110,168,255,.6); }
    .muted{ color:var(--muted); font-size:12px; }

    @media (max-width: 720px){ .app{ width:100vw; min-height:100svh; border-radius:0; } .display{ font-size:48px; } }
  </style>
</head>
<body>
  <main class="app" aria-label="タイマー" data-mode="kitchen">
    <div class="header">
      <div class="title">簡易電卓 - タイマー</div>
      <div id="modeLabel" style="color:var(--muted); font-size:12px;">キッチン</div>
    </div>
    <nav class="tabs" aria-label="ナビゲーション">
      <a class="tab" href="./">電卓</a>
      <a class="tab" href="./help.html">説明</a>
      <a class="tab" href="./memo.html">メモ</a>
      <a class="tab" href="./camera.html">カメラ</a>
      <a class="tab active" href="./timer.html">タイマー</a>
      <a class="tab" href="./convert.html">換算</a>
      <a class="tab" href="./password.html">PW</a>
      <a class="tab" href="./voice.html">音声</a>
      <a class="tab" href="./music.html">音楽</a>
      <a class="tab" href="./calendar.html">カレンダー</a>
    </nav>

    <section class="content">
      <div class="mode-tabs" role="tablist" aria-label="タイマーモード">
        <button class="mode-tab" data-mode="pomodoro" role="tab" aria-selected="false">ポモドーロ</button>
        <button class="mode-tab" data-mode="kitchen" role="tab" aria-selected="true">キッチン</button>
      </div>
      <div id="display" class="display">03:00</div>
      <div class="progress" aria-label="進捗"><div id="bar" class="bar"></div></div>
      <div id="pomodoroBox">
        <div class="presets">
          <button data-preset="pomodoro" title="作業25/短休5/長休15 x4">ポモドーロ</button>
          <button data-preset="short" title="作業10/短休2/長休5 x3">短め</button>
          <button data-preset="long" title="作業45/短休10/長休20 x2">じっくり</button>
        </div>
      </div>
      <div class="controls">
        <button id="startBtn">開始</button>
        <button id="pauseBtn">一時停止</button>
        <button id="resetBtn">リセット</button>
        <button id="nextBtn">次へ</button>
        <button id="soundBtn" title="通知音の設定">音設定</button>
      </div>
      <div id="pomodoroBox2" class="settings">
        <label>作業(分) <input id="workMin" type="number" min="1" step="1"></label>
        <label>短休(分) <input id="shortMin" type="number" min="1" step="1"></label>
        <label>長休(分) <input id="longMin" type="number" min="1" step="1"></label>
        <label>ラウンド <input id="rounds" type="number" min="1" step="1"></label>
      </div>
      <div id="cycle" class="cycle">状態: 作業 1/4</div>
      <div id="sessions" class="sessions"></div>

      <div id="kitchenBox">
        <div class="presets" id="kPresets">
          <button data-k="30">30秒</button>
          <button data-k="60">1分</button>
          <button data-k="180">3分</button>
          <button data-k="300">5分</button>
          <button data-k="600">10分</button>
        </div>
        <div class="settings">
          <label>分 <input id="kMin" type="number" min="0" step="1"></label>
          <label>秒 <input id="kSec" type="number" min="0" max="59" step="1"></label>
          <button id="kApply" title="入力値を表示へ反映">反映</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Sound Settings Modal -->
  <div id="sndBackdrop" class="modal-backdrop" role="presentation"></div>
  <div id="sndModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="sndTitle" aria-hidden="true">
    <div class="hd"><span id="sndTitle">通知音の設定</span></div>
    <div class="bd">
      <fieldset>
        <legend class="muted">種類</legend>
        <div style="display:grid; gap:6px; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));">
          <label><input type="radio" name="sndKind" value="beep"> ビープ</label>
          <label><input type="radio" name="sndKind" value="bell"> ベル</label>
          <label><input type="radio" name="sndKind" value="digital"> デジタル</label>
          <label><input type="radio" name="sndKind" value="gentle"> ソフト</label>
          <label><input type="radio" name="sndKind" value="alarm"> アラーム</label>
          <label><input type="radio" name="sndKind" value="custom"> カスタム</label>
        </div>
      </fieldset>
      <div id="customRow" style="display:none;">
        <label>ファイル<input id="sndFile" type="file" accept="audio/*"></label>
        <div class="muted">カスタム音はこのページを閉じるまで有効です。</div>
      </div>
      <div>
        <label>音量 <input id="sndVol" type="range" min="0" max="1" step="0.01"></label>
        <label><input id="sndLoop" type="checkbox"> 繰り返し</label>
      </div>
      <div style="display:flex; gap:8px;">
        <button id="sndTest" class="btn" type="button">テスト再生</button>
        <button id="sndStop" class="btn" type="button">停止</button>
      </div>
    </div>
    <div class="ft">
      <button id="sndClose" class="btn" type="button">閉じる</button>
      <button id="sndSave" class="btn primary" type="button">保存</button>
    </div>
  </div>

  <script>
    (function(){
      const S = {
        work: +(localStorage.getItem('timer_work')||25),
        short: +(localStorage.getItem('timer_short')||5),
        long: +(localStorage.getItem('timer_long')||15),
        rounds: +(localStorage.getItem('timer_rounds')||4),
      };
      const K = {
        min: +(localStorage.getItem('timer_k_min')||3),
        sec: +(localStorage.getItem('timer_k_sec')||0),
      };
      const el = {
        disp: document.getElementById('display'),
        start: document.getElementById('startBtn'),
        pause: document.getElementById('pauseBtn'),
        reset: document.getElementById('resetBtn'),
        next: document.getElementById('nextBtn'),
        soundBtn: document.getElementById('soundBtn'),
        work: document.getElementById('workMin'),
        short: document.getElementById('shortMin'),
        long: document.getElementById('longMin'),
        rounds: document.getElementById('rounds'),
        cycle: document.getElementById('cycle'),
        sessions: document.getElementById('sessions'),
        bar: document.getElementById('bar'),
        modeTabs: document.querySelectorAll('.mode-tab'),
        app: document.querySelector('main.app'),
        modeLabel: document.getElementById('modeLabel'),
        kMin: document.getElementById('kMin'),
        kSec: document.getElementById('kSec'),
        kPresets: document.getElementById('kPresets'),
        kApply: document.getElementById('kApply'),
        // modal
        sndBackdrop: document.getElementById('sndBackdrop'),
        sndModal: document.getElementById('sndModal'),
        sndKind: document.querySelectorAll('input[name="sndKind"]'),
        sndFile: document.getElementById('sndFile'),
        sndVol: document.getElementById('sndVol'),
        sndLoop: document.getElementById('sndLoop'),
        sndTest: document.getElementById('sndTest'),
        sndStop: document.getElementById('sndStop'),
        sndSave: document.getElementById('sndSave'),
        sndClose: document.getElementById('sndClose'),
        customRow: document.getElementById('customRow'),
      };
      el.work.value = S.work; el.short.value = S.short; el.long.value = S.long; el.rounds.value = S.rounds;
      el.kMin.value = K.min; el.kSec.value = K.sec;

      let timer=null, endAt=0, phase='work', count=0, totalMs=0; // count=作業数
      let mode = localStorage.getItem('timer_mode') || 'kitchen';

      function saveSettings(){
        // 入力値を設定へ反映しつつ永続化
        S.work = +el.work.value;
        S.short = +el.short.value;
        S.long = +el.long.value;
        S.rounds = +el.rounds.value;
        localStorage.setItem('timer_work', S.work);
        localStorage.setItem('timer_short', S.short);
        localStorage.setItem('timer_long', S.long);
        localStorage.setItem('timer_rounds', S.rounds);
      }
      el.work.onchange = saveSettings; el.short.onchange = saveSettings; el.long.onchange = saveSettings; el.rounds.onchange = saveSettings;

      function saveKitchen(){
        K.min = Math.max(0, +el.kMin.value|0);
        K.sec = Math.max(0, Math.min(59, +el.kSec.value|0));
        el.kMin.value = K.min; el.kSec.value = K.sec;
        localStorage.setItem('timer_k_min', K.min);
        localStorage.setItem('timer_k_sec', K.sec);
      }
      el.kMin.onchange = saveKitchen; el.kSec.onchange = saveKitchen;
      el.kApply && (el.kApply.onclick = ()=>{ saveKitchen(); reset(); });

      function mmss(ms){ const t = Math.max(0, Math.floor(ms/1000)); const m=('0'+Math.floor(t/60)).slice(-2); const s=('0'+(t%60)).slice(-2); return m+':'+s; }
      function vibrate(){ try{ navigator.vibrate?.(200); }catch(_){} }
      function notify(text){ try{ if (Notification?.permission==='granted'){ new Notification(text); } else if (Notification && Notification.permission!=='denied'){ Notification.requestPermission(); } }catch(_){} }

      function beep(){
        try{
          const AC = window.AudioContext || window.webkitAudioContext; if(!AC) return;
          const ac = new AC();
          const osc = ac.createOscillator();
          const gain = ac.createGain();
          osc.type = 'sine';
          osc.frequency.value = 880;
          osc.connect(gain); gain.connect(ac.destination);
          const t0 = ac.currentTime;
          gain.gain.setValueAtTime(0.0001, t0);
          gain.gain.linearRampToValueAtTime(0.2, t0+0.02);
          gain.gain.exponentialRampToValueAtTime(0.0001, t0+0.35);
          osc.start(t0);
          osc.stop(t0+0.4);
          setTimeout(()=>ac.close(), 600);
        }catch(_){ }
      }

      // === Sound Settings ===
      const SOUND = {
        id: localStorage.getItem('timer_sound_id') || 'beep',
        volume: +(localStorage.getItem('timer_sound_volume')||0.7),
        loop: localStorage.getItem('timer_sound_loop') === '1'
      };
      let ac=null, master=null, alarmTimer=null, customAudio=null;
      function ensureAC(){
        const AC = window.AudioContext || window.webkitAudioContext; if(!AC) return null;
        if (!ac) { ac = new AC(); master = ac.createGain(); master.gain.value = SOUND.volume; master.connect(ac.destination); }
        return ac;
      }
      function setVolume(v){ SOUND.volume = v; if (master) master.gain.value = v; }
      function stopAlarm(){
        try{ if (alarmTimer){ clearInterval(alarmTimer); alarmTimer=null; } }catch(_){ }
        try{ if (customAudio){ customAudio.pause(); customAudio.currentTime=0; } }catch(_){ }
        // Note: Oscillator nodes are one-shot; intervals cover repetition
      }
      function playPresetOnce(kind){
        const ctx = ensureAC(); if (!ctx) { beep(); return; }
        const g = ctx.createGain(); g.gain.value = SOUND.volume; g.connect(master);
        const o1 = ctx.createOscillator(); o1.connect(g);
        const now = ctx.currentTime;
        if (kind==='beep'){
          o1.type='sine'; o1.frequency.setValueAtTime(880, now);
          g.gain.setValueAtTime(0.0001, now);
          g.gain.linearRampToValueAtTime(SOUND.volume, now+0.02);
          g.gain.exponentialRampToValueAtTime(0.0001, now+0.35);
          o1.start(now); o1.stop(now+0.4);
        } else if (kind==='bell'){
          o1.type='sine'; o1.frequency.setValueAtTime(1320, now);
          const o2 = ctx.createOscillator(); o2.type='sine'; o2.frequency.setValueAtTime(990, now); const g2 = ctx.createGain(); g2.gain.value = SOUND.volume*0.5; o2.connect(g2); g2.connect(master); o2.start(now); o2.stop(now+1.2);
          g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(SOUND.volume*0.9, now+0.01); g.gain.exponentialRampToValueAtTime(0.0001, now+1.2);
          o1.start(now); o1.stop(now+1.2);
        } else if (kind==='digital'){
          o1.type='square'; o1.frequency.setValueAtTime(1000, now);
          g.gain.setValueAtTime(0.0001, now);
          g.gain.linearRampToValueAtTime(SOUND.volume, now+0.005);
          g.gain.setValueAtTime(SOUND.volume, now+0.12);
          g.gain.exponentialRampToValueAtTime(0.0001, now+0.15);
          o1.start(now); o1.stop(now+0.16);
        } else if (kind==='gentle'){
          o1.type='triangle'; o1.frequency.setValueAtTime(440, now);
          g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(SOUND.volume*0.6, now+0.08); g.gain.exponentialRampToValueAtTime(0.0001, now+0.8);
          o1.start(now); o1.stop(now+0.9);
        } else { // alarm pattern short burst
          o1.type='sawtooth'; o1.frequency.setValueAtTime(880, now);
          g.gain.setValueAtTime(0.0001, now); g.gain.linearRampToValueAtTime(SOUND.volume, now+0.01); g.gain.setValueAtTime(SOUND.volume, now+0.2); g.gain.exponentialRampToValueAtTime(0.0001, now+0.25);
          o1.start(now); o1.stop(now+0.26);
        }
      }
      function startAlarm(){
        stopAlarm();
        if (SOUND.id==='custom' && customAudio){
          try{ customAudio.loop = !!SOUND.loop; customAudio.volume = SOUND.volume; customAudio.currentTime=0; customAudio.play().catch(()=>{}); }catch(_){ }
          return;
        }
        // play preset once or loop
        playPresetOnce(SOUND.id);
        if (SOUND.loop){ alarmTimer = setInterval(()=> playPresetOnce(SOUND.id), 800); }
      }

      // Modal wiring
      function openSnd(){
        // reflect current
        el.sndKind.forEach(r=> r.checked = (r.value===SOUND.id));
        el.sndVol.value = String(SOUND.volume);
        el.sndLoop.checked = !!SOUND.loop;
        el.customRow.style.display = (SOUND.id==='custom') ? '' : 'none';
        el.sndBackdrop.style.display = 'block';
        el.sndModal.style.display = 'block';
        el.sndModal.setAttribute('aria-hidden','false');
      }
      function closeSnd(){
        el.sndBackdrop.style.display = 'none';
        el.sndModal.style.display = 'none';
        el.sndModal.setAttribute('aria-hidden','true');
      }
      el.soundBtn.onclick = ()=> openSnd();
      el.sndBackdrop.onclick = ()=> closeSnd();
      el.sndClose.onclick = ()=> closeSnd();
      el.sndKind.forEach(r=> r.addEventListener('change', ()=>{ if (r.checked){ el.customRow.style.display = (r.value==='custom')?'':'none'; }}));
      el.sndVol.oninput = ()=> setVolume(+el.sndVol.value);
      el.sndLoop.onchange = ()=> { SOUND.loop = !!el.sndLoop.checked; };
      el.sndTest.onclick = ()=> { ensureAC(); startAlarm(); if (!SOUND.loop){ setTimeout(()=> stopAlarm(), 1500); } };
      el.sndStop.onclick = ()=> stopAlarm();
      el.sndSave.onclick = ()=>{
        // apply selected kind
        const sel = Array.from(el.sndKind).find(r=>r.checked)?.value || 'beep';
        SOUND.id = sel; SOUND.loop = !!el.sndLoop.checked; setVolume(+el.sndVol.value);
        localStorage.setItem('timer_sound_id', SOUND.id);
        localStorage.setItem('timer_sound_volume', String(SOUND.volume));
        localStorage.setItem('timer_sound_loop', SOUND.loop?'1':'0');
        closeSnd();
      };
      el.sndFile.onchange = ()=>{
        try{
          const f = el.sndFile.files?.[0]; if (!f) return;
          if (customAudio){ try{ customAudio.pause(); }catch(_){} }
          customAudio = new Audio(); customAudio.src = URL.createObjectURL(f); customAudio.preload='auto';
          SOUND.id = 'custom'; el.sndKind.forEach(r=> r.checked = (r.value==='custom'));
        }catch(_){ }
      };

      function updateProgress(remain){ if (!totalMs) { el.bar.style.width = '0%'; return; } const done = Math.max(0, Math.min(1, 1 - (remain/totalMs))); el.bar.style.width = (done*100).toFixed(1) + '%'; }

      function setPhase(p){
        phase=p;
        if (p==='work'){ totalMs = S.work*60*1000; el.cycle.textContent = `状態: 作業 ${count+1}/${el.rounds.value}`; }
        else if (p==='short'){ totalMs = S.short*60*1000; el.cycle.textContent = '状態: 短い休憩'; }
        else { totalMs = S.long*60*1000; el.cycle.textContent = '状態: 長い休憩'; }
        endAt = Date.now() + totalMs;
        updateProgress(totalMs);
      }
      function renderSessions(){
        const arr=[]; for(let i=0;i<count;i++) arr.push('<span class="pill">作業</span>'); el.sessions.innerHTML = arr.join(' ');
      }
      function tick(){
        const remain = endAt - Date.now();
        el.disp.textContent = mmss(remain);
        updateProgress(Math.max(0, remain));
        if (remain<=0){
          clearInterval(timer); timer=null; updateProgress(0);
          vibrate(); beep();
          if (mode==='pomodoro'){
            if (phase==='work'){
              count++; renderSessions(); const goal = +el.rounds.value;
              if (count%goal===0){ setPhase('long'); notify('長い休憩'); }
              else { setPhase('short'); notify('短い休憩'); }
            } else {
              setPhase('work'); notify('作業再開');
            }
            start();
          } else {
            notify('時間です');
          }
          // play selected alarm
          try{ startAlarm(); }catch(_){ }
        }
      }

      function start(){ if (timer) return; timer = setInterval(tick, 200); }
      function pause(){ if (!timer) return; clearInterval(timer); timer=null; }
      function reset(){
        pause();
        stopAlarm();
        if (mode==='pomodoro'){
          count=0; renderSessions(); setPhase('work'); el.disp.textContent = mmss(S.work*60*1000); updateProgress(0);
          el.next.style.display=''; el.cycle.style.display=''; el.sessions.style.display='';
        } else {
          totalMs = (K.min*60 + K.sec)*1000; endAt=0; el.disp.textContent = mmss(totalMs); updateProgress(0);
          el.next.style.display='none'; el.cycle.style.display='none'; el.sessions.style.display='none';
        }
      }
      function next(){ if (mode!=='pomodoro') return; pause(); if (phase==='work'){ count++; renderSessions(); const goal = +el.rounds.value; if (count%goal===0){ setPhase('long'); } else { setPhase('short'); } } else { setPhase('work'); } start(); }

      el.start.onclick = ()=>{
        if (!timer){
          if (!endAt){
            if (mode==='pomodoro') setPhase(phase);
            else { totalMs = (K.min*60 + K.sec)*1000; endAt = Date.now() + totalMs; updateProgress(totalMs); }
          }
          start();
        }
      };
      el.pause.onclick = ()=> pause();
      el.reset.onclick = ()=> reset();
      el.next.onclick = ()=> next();

      // プリセット (Pomodoro)
      document.querySelector('.presets')?.addEventListener('click', (e)=>{
        const btn = e.target.closest('button[data-preset]'); if (!btn) return;
        const p = btn.dataset.preset;
        if (p==='pomodoro'){ el.work.value=25; el.short.value=5; el.long.value=15; el.rounds.value=4; }
        else if (p==='short'){ el.work.value=10; el.short.value=2; el.long.value=5; el.rounds.value=3; }
        else if (p==='long'){ el.work.value=45; el.short.value=10; el.long.value=20; el.rounds.value=2; }
        saveSettings();
        reset();
      });

      // プリセット (Kitchen)
      el.kPresets?.addEventListener('click', (e)=>{
        const b = e.target.closest('button[data-k]'); if (!b) return;
        const s = +b.dataset.k; K.min = Math.floor(s/60); K.sec = s%60; el.kMin.value = K.min; el.kSec.value = K.sec; saveKitchen(); reset();
      });

      // キーボード: Space=開始/停止, R=リセット, N=次へ(ポモドーロのみ)
      window.addEventListener('keydown', (e)=>{
        if (e.code==='Space') { e.preventDefault(); if (timer) pause(); else { if (!endAt) { if (mode==='pomodoro') setPhase(phase); else { totalMs = (K.min*60 + K.sec)*1000; endAt = Date.now() + totalMs; updateProgress(totalMs); } } start(); } }
        else if (e.key==='r' || e.key==='R') { reset(); }
        else if (e.key==='n' || e.key==='N') { if (mode==='pomodoro') next(); }
      });

      // Mode tabs
      function applyMode(){
        el.app.setAttribute('data-mode', mode);
        el.modeLabel.textContent = (mode==='pomodoro') ? 'ポモドーロ' : 'キッチン';
        el.modeTabs.forEach(btn=> btn.setAttribute('aria-selected', String(btn.dataset.mode===mode)) );
        localStorage.setItem('timer_mode', mode);
        reset();
      }
      el.modeTabs.forEach(btn=> btn.addEventListener('click', ()=>{ const m = btn.dataset.mode; if (m && m!==mode){ mode=m; applyMode(); } }));

      // SW
      if ('serviceWorker' in navigator) { window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js').catch(()=>{}); }); }

      applyMode();
    })();
  </script>
</body>
</html>
